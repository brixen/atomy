test(namespaces)

describe("namespaces"):
  describe(#no-namespace):
    it("executes a block without any namespace"):
      no-namespace { ^namespace } should-be(nil)

  describe(#in-namespace):
    it("creates a new namespace if it does not exist"):
      in-namespace(foo):
        ^namespace register(#fizz)

    it("switches to an existing namespace"):
      in-namespace(foo):
        ^namespace should: contains?(#fizz)

  describe(#use):
    it("modifies the current namespace to use another"):
      in-namespace(foo):
        use(foo)
        ^namespace using should: include?(#foo)

    it("accepts multiple arguments"):
      in-namespace(x):
        foo := 1

      in-namespace(y):
        bar := 1

      in-namespace(z):
        use(x, y)
        foo should-be(1)
        bar should-be(1)

    it("ignores duplicates"):
      in-namespace(foo):
        use(foo)
        ^namespace using count(#foo) should-be(1)

  describe(#symbols):
    it("registers the given names in the current namespace"):
      in-namespace(foo):
        symbols(foo, bar)
        ^namespace should:
          contains?(#fizz) &&
            contains?(#foo) &&
              contains?(#bar)

  describe("macro namespacing"):
    it("should register macros only in the current namespace"):
      var = 0

      in-namespace(foo-0):
        macro(var): '1
        var should-be(1)

      in-namespace(bar-0):
        macro(var): '2
        var should-be(2)
      
      var should-be(0)

    it("should resolve a macro's body in its namespace"):
      n-foo-0 := 0

      in-namespace(foo-1):
        n-foo-1 := 1
        macro(m-foo-1): '(n-foo-1())

      in-namespace(bar-1):
        use(foo-1)
        'm-foo-1 expand namespace should-be("foo_1")
        m-foo-1 should-be(1)

  describe("definition namespacing"):
    it("should register methods only in the current namespace"):
      n-foo-1 := 0

      in-namespace(foo):
        n-foo-1 := 1
        n-foo-1 should-be(1)

      in-namespace(bar):
        n-foo-1 := 2
        n-foo-1 should-be(2)
      
      n-foo-1 should-be(0)

    it("should resolve a method's body in its namespace"):
      n-foo-2 := 0

      in-namespace(foo-2):
        n-foo-2 := 1
        n-foo-3 := n-foo-2

      in-namespace(bar-2):
        use(tests/namespaces)
        n-foo-2 should-be(0)
        foo-2/n-foo-3 should-be(1)

  describe(#export):
    it("executes the body with definitions going to the bottom namespace"):
      in-namespace(bar-3):
        n-foo-4 := 0

        export:
          n-foo-5 := n-foo-4

        n-foo-4 should-be(0)

      ^namespace should: !contains?(#n-foo-5)
      'n-foo-5 resolve namespace should-be("_")
      n-foo-5 should-be(0)

    it("resolves the method bodies in the current namespace"):
      n-foo-5 should-be(0)
      n-foo-4 := 1
      n-foo-5 should-be(0)

    it("registers macros in the bottom namespace"):
      var-1 = 0

      in-namespace(foo-4):
        export:
          macro(var-1): '1
      
      var-1 should-be(1)

    it("resolves a macro's body in its namespace"):
      n-foo-6 := 0

      in-namespace(foo-5):
        n-foo-7 := 1
        export:
          macro(m-foo-2): '(n-foo-7())

      'm-foo-2 expand namespace should-be("foo_5")
      m-foo-2 should-be(1)

  describe(#export-to):
    it("executes the body with definitions going to a given namespace"):
      in-namespace(foo-6) {}

      in-namespace(bar-7):
        foo := 0

        export-to(foo-6):
          bar := foo
          foo should-be(0)

        foo should-be(0)

      in-namespace(foo-6):
        bar should-be(0)
        foo := 1
        bar should-be(0)

    it("resolves the method bodies in the current namespace"):
      in-namespace(foo-6):
        bar should-be(0)
        foo := 1
        bar should-be(0)

    it("registers macros in the given namespace"):
      var-2 = 0

      in-namespace(foo-8):
        macro(var-2): '1
        var-2 should-be(1)

      in-namespace(bar-9):
        export-to(foo-8):
          macro(var-2): '2

        var-2 should-be(0)
      
      in-namespace(foo-8):
        var-2 should-be(2)

      var-2 should-be(0)

    it("resolves a macro's body in its namespace"):
      n-foo-8 := 0

      in-namespace(foo-9) {}

      in-namespace(foo-10):
        n-foo-9 := 1
        export-to(bar-9):
          macro(m-foo-1): '(n-foo-9())

      in-namespace(bar-9):
        use(foo-8)
        'm-foo-1 expand namespace should-be("foo_10")
        m-foo-1 should-be(1)

  it("allows calling methods in other namespaces"):
    no-namespace:
      1 atomy/should-be(1)
