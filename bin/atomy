#!/usr/bin/env rbx
# vim: ft=ruby

unless Rubinius.ruby19?
  puts("Atomy must be run in 1.9 mode.")
  exit(1)
end

require 'readline'
require 'optparse'
require 'profiler'

require File.expand_path("../../lib/atomy/boot", __FILE__)

options = {}

unless ARGV.empty? || ARGV[0][0] != ?-
  OptionParser.new do |o|
    o.banner = "usage: atomy [options]"

    o.on("-B", "--print-bytecode", "print out compiled bytecode") do |v|
      options[:debug] = v
    end

    o.on("-e", "--evaluate EXPR", "evaluate EXPR and print the result") do |v|
      options[:evaluate] = v
    end

    o.on("-s", "--before-start EXPR", "evaluate EXPR beforehand") do |v|
      options[:start] = v
    end

    o.on("-l", "--load FILE", "load FILENAME and start the REPL") do |v|
      options[:load] = v
    end

    o.on("-x", "--skip-kernel", "don't load the kernel") do
      options[:skip_kernel] = true
    end

    o.on("-p", "--profile", "perform profiling") do
      options[:profile] = true
    end

    o.on_tail("-h", "--help", "show this message") do
      puts o
      exit
    end
  end.parse!
end

unless options[:skip_kernel]
  require("boot")
end

if options[:profile]
  profiler = Rubinius::Profiler::Instrumenter.new
  profiler.start
end

def run_atomy(options)
  if str = options[:evaluate] || options[:start]
    $0 = "(eval)"
    mod = Atomy.make_wrapper_module(:"(eval)")
    res = Atomy::Compiler.eval(
      str,
      mod,
      TOPLEVEL_BINDING,
      mod.file,
      1,
      options[:debug]
    )

    if options[:evaluate]
      p(res)
      return
    end
  end

  if file = options[:load] || ARGV[0]
    $0 = file
    run = ARGV.shift
    Atomy.load(file, options[:debug])
    return if run
  end


  require("repl").repl(
    File.expand_path("~/.atomy_history"),
    TOPLEVEL_BINDING,
    options[:debug]
  )
end

begin
  run_atomy(options)
ensure
  if options[:profile]
    profiler.stop
    #data = profiler.info
    profiler.show
  end
end
