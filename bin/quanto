#!/usr/bin/env rbx

base = File.expand_path "../../lib/atomo/", __FILE__
kernel = File.expand_path "../../kernel/", __FILE__

require 'readline'

require base + '/macros'
require base + "/compiler/compiler"
require base + "/compiler/stages"
require base + '/parser'
require base + '/code_loader'

bnd = TOPLEVEL_BINDING

Kernel.send(:define_method, :"load:") do |*as|
  Atomo::CodeLoader.load_file *as
end

a = Time.now
puts "loading kernel"
send(:"load:", kernel + "/boot.atomo")
puts Time.now - a

if ARGV[0]
  send(:"load:", ARGV[0])
  exit(0)
end

while str = Readline.readline("> ")
  next if str.empty?

  begin
    res = Atomo::Compiler.evaluate str, bnd
    puts "=> #{res.pretty.render}"
  rescue StandardError => e
    puts "ERROR!"
    puts "#{e}:\n  #{e.message}"
    puts e.backtrace
  end
end
