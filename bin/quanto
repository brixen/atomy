#!/usr/bin/env rbx

base = File.expand_path "../../lib/atomo/", __FILE__
kernel = File.expand_path "../../kernel/", __FILE__

require 'readline'

require base + '/macros'
require base + "/compiler/compiler"
require base + "/compiler/stages"
require base + '/parser'

bnd = binding()

Kernel.send(:define_method, :"load:") do |a|
  cm = Atomo::Compiler.compile_file a

  cm.create_script(false)

  MAIN.__send__ :__script__
end

a = Time.now
puts "loading core"
send(:"load:", kernel + "/core.atomo")
puts "loading errors"
send(:"load:", kernel + "/errors.atomo")
puts "loading therie"
send(:"load:", kernel + "/therie.atomo")
puts "loading mixins"
send(:"load:", kernel + "/mixins.atomo")
puts "loading pretty"
send(:"load:", kernel + "/pretty.atomo")
puts Time.now - a

while str = Readline.readline("> ")
  next if str.empty?

  begin
    res = Atomo::Compiler.evaluate str, bnd
    puts "=> #{res.pretty.render}"
  rescue StandardError => e
    puts "ERROR!"
    puts "#{e}:\n  #{e.message}"
    puts e.backtrace
  end
end
