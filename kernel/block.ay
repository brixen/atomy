macro(x onto ~(b: Block)):
  names [ctx]:
    shadowed? = false

    blk = b through-quotes [n]:
      n match:
        `@~(v: Variable):
          shadowed? =! true
          `(~ctx instance-variable-get(#~("@" + v name)))

        'self:
          shadowed? =! true
          ctx

        Compose ? @headless ->
          n dup tap [p]:
            p receiver = 'self

        Binary ? @private ->
          n dup tap [p]:
            p lhs = 'self

        _ ->
          n

    if(shadowed?)
      then: `(do: ~ctx = self, ~blk block call-on-instance(~x))
      else: `(~b block call-on-instance(~x))
